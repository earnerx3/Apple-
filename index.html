<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Apple Earn BD - Premium</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --primary: #FF3B30; 
            --primary-grad: linear-gradient(135deg, #FF3B30 0%, #FF9F0A 100%);
            --bg-dark: #000000;
            --glass-bg: rgba(28, 28, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.12);
            --text-main: #ffffff;
            --text-muted: #8e8e93;
            --success: #30D158;
            --danger: #FF453A;
            --card-bg: #1C1C1E;
            --gold: #FFD700;
            --warning: #FF9F0A;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at top right, rgba(255, 59, 48, 0.15), transparent 40%);
            color: var(--text-main);
            font-family: 'Poppins', sans-serif; 
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .bn { font-family: 'Hind Siliguri', sans-serif; }

        /* --- Utilities --- */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
        }

        .gradient-text {
            background: var(--primary-grad);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .btn-main {
            background: var(--primary-grad);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 14px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            box-shadow: 0 8px 20px rgba(255, 59, 48, 0.3);
            position: relative;
            overflow: hidden;
        }
        .btn-main:active { transform: scale(0.97); }
        .btn-main:disabled { background: #333; color: #666; box-shadow: none; transform: none; }
        .btn-check { background: var(--success); box-shadow: 0 4px 15px rgba(48, 209, 88, 0.3); }

        /* --- Layout --- */
        #app-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 100px;
            scroll-behavior: smooth;
        }
        #app-content::-webkit-scrollbar { width: 0px; background: transparent; }

        .page { display: none; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .page.active { display: block; }

        /* --- Header --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .user-pill { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 48px; height: 48px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; }
        .wallet-badge {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            padding: 8px 16px; border-radius: 30px; font-weight: 600; font-size: 0.9rem;
            display: flex; align-items: center; gap: 8px;
        }

        /* --- Premium Ad Card --- */
        .premium-ad-card {
            position: relative;
            background: #1C1C1E; 
            border-radius: 16px; 
            padding: 20px; 
            text-align: center;
            margin-bottom: 25px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        .premium-ad-card::before {
            content: ''; position: absolute; width: 150%; height: 150%;
            background: conic-gradient(transparent 0deg, transparent 80deg, #FF3B30 100deg, transparent 140deg, transparent 220deg, #007AFF 260deg, transparent 300deg);
            animation: rotateBorder 4s linear infinite; z-index: -2;
        }
        .premium-ad-card::after {
            content: ''; position: absolute; inset: 2px; background: #1C1C1E; border-radius: 15px; z-index: -1;
        }
        .ad-icon-small { font-size: 2.2rem; color: var(--primary); margin-bottom: 8px; filter: drop-shadow(0 0 10px rgba(255, 59, 48, 0.6)); }

        /* --- Leaderboard Styles --- */
        .rank-list { margin-top: 10px; }
        .rank-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px; margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px; border: 1px solid rgba(255,255,255,0.05);
            transition: 0.3s;
        }
        .rank-item.top-1 { 
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(0,0,0,0)); 
            border: 1px solid rgba(255, 215, 0, 0.4);
            animation: pulseGold 2s infinite;
        }
        .rank-item.top-2 { border: 1px solid rgba(192, 192, 192, 0.3); }
        .rank-item.top-3 { border: 1px solid rgba(205, 127, 50, 0.3); }
        .rank-num {
            width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; margin-right: 12px; font-size: 0.9rem; background: #2C2C2E; color: #888;
        }
        .top-1 .rank-num { background: #FFD700; color: #000; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .top-2 .rank-num { background: #C0C0C0; color: #000; }
        .top-3 .rank-num { background: #CD7F32; color: #fff; }
        .rank-img { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
        .top-1 .rank-img { border: 2px solid #FFD700; }
        .rank-info { flex: 1; }
        .rank-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; }
        .rank-stats { font-size: 0.75rem; color: #888; display: flex; gap: 10px; }
        .like-btn { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 5px; color: #666; transition: 0.2s; }
        .like-btn.liked { color: #FF2D55; animation: pop 0.3s ease; }
        .like-btn i { font-size: 1.2rem; margin-bottom: 2px; }
        .like-count { font-size: 0.7rem; }

        /* --- Other Styles --- */
        .balance-card { padding: 25px; text-align: center; position: relative; overflow: hidden; margin-bottom: 25px; }
        .balance-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,59,48,0.1) 0%, transparent 70%);
            animation: rotate 10s linear infinite;
        }
        .task-box { background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 18px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; transition: 0.3s; }
        .task-icon { width: 50px; height: 50px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--text-main); margin-right: 15px; }
        .task-reward { color: var(--success); font-weight: bold; font-size: 0.9rem; background: rgba(48,209,88,0.1); padding: 2px 8px; border-radius: 6px; }

        .tab-container { display: flex; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; text-align: center; border-radius: 12px; font-size: 0.9rem; color: #888; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: #fff; font-weight: 600; }

        /* Notification */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); border-left: 4px solid var(--primary); color: white; padding: 15px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px; animation: slideDown 0.3s ease-out forwards; font-family: 'Hind Siliguri', sans-serif; }
        .toast.success { border-color: var(--success); } .toast.error { border-color: var(--danger); }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-box { width: 85%; max-width: 360px; background: #1C1C1E; border-radius: 20px; padding: 25px; border: 1px solid var(--glass-border); transform: scale(0.9); transition: 0.3s; position: relative; }
        .modal-overlay.show .modal-box { transform: scale(1); }
        .notice-content { max-height: 50vh; overflow-y: auto; margin: 15px 0; font-size: 0.9rem; line-height: 1.6; color: #ccc; }

        .form-control { width: 100%; padding: 14px; background: #000; border: 1px solid #333; color: white; border-radius: 10px; outline: none; font-family: 'Poppins'; margin-bottom: 15px; }

        /* Nav */
        .nav-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 450px; height: 70px; background: rgba(30, 30, 30, 0.85); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 25px; display: flex; justify-content: space-around; align-items: center; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; text-decoration: none; font-size: 0.7rem; gap: 4px; width: 50px; height: 50px; border-radius: 50%; transition: 0.3s; }
        .nav-item i { font-size: 1.4rem; transition: 0.3s; }
        .nav-item.active { background: var(--primary); color: white; transform: translateY(-15px); box-shadow: 0 5px 15px rgba(255, 59, 48, 0.4); }
        .nav-item.active i { color: white; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes rotateBorder { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseGold { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }
        @keyframes pop { 50% { transform: scale(1.4); } }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(255, 59, 48, 0.5); } 100% { transform: scale(1); } }
        @keyframes bounceApple { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        .loader-spin { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: rotate 1s linear infinite; }

        /* Warning Box Style */
        .warning-box {
            background: rgba(255, 159, 10, 0.1);
            border: 1px solid rgba(255, 159, 10, 0.3);
            border-radius: 14px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .warning-header {
            color: var(--warning);
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>

    <div id="appLoader" class="modal-overlay show" style="background: #000; z-index: 9999; flex-direction: column;">
        <div style="text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <i class="fab fa-apple" style="font-size: 5rem; color: var(--primary); margin-bottom: 20px; animation: bounceApple 1.5s infinite ease-in-out;"></i>
            <div style="width: 200px; height: 6px; background: #333; border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
                <div id="loadingBar" style="width: 0%; height: 100%; background: var(--primary-grad); transition: width 0.1s linear;"></div>
            </div>
            <h3 class="bn" style="color: #fff; font-size: 1.2rem;">‡¶≤‡ßã‡¶°‡¶ø‡¶Ç <span id="loadPercent">0</span>%</h3>
        </div>
        <div style="margin-bottom: 30px; text-align: center;">
            <p style="color: #444; font-size: 0.7rem; letter-spacing: 1px; font-family: monospace;">OPTIMIZED ‚Ä¢ SECURE ‚Ä¢ FAST</p>
        </div>
    </div>

    <div id="toast-container"></div>

    <div id="noticeModal" class="modal-overlay">
        <div class="modal-box">
            <div style="text-align: center;">
                <div style="width: 50px; height: 50px; background: rgba(255,59,48,0.1); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                    <i class="fas fa-bullhorn" style="color: var(--primary); font-size: 1.5rem;"></i>
                </div>
                <h3 class="bn">‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡ßã‡¶ü‡¶ø‡¶∂</h3>
            </div>
            <div class="notice-content bn" id="noticeText">‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
            <button class="btn-main" onclick="closeModal('noticeModal')">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá, ‡¶¨‡ßÅ‡¶ù‡ßá‡¶õ‡¶ø</button>
        </div>
    </div>

    <!-- Ad Modal Removed (Secure Logic Implemented) -->

    <div id="app-content">

        <div id="home" class="page active">
            <div class="header">
                <div class="user-pill">
                    <img src="" id="userAvatar" class="user-avatar">
                    <div>
                        <div class="bn" style="font-size: 0.7rem; color: var(--text-muted);">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ,</div>
                        <div style="font-weight: 600; font-size: 1rem;" id="userName">Guest</div>
                    </div>
                </div>
                <div class="wallet-badge">
                    <i class="fas fa-coins" style="color: var(--primary);"></i>
                    <span id="topBalance">0.00</span> ‡ß≥
                </div>
            </div>

            <div class="balance-card glass">
                <p class="bn" style="color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                <h1 style="font-size: 2.8rem; margin: 10px 0;" class="gradient-text">‡ß≥ <span id="mainBalance">0.00</span></h1>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <div style="flex: 1; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px;">
                        <small class="bn" style="color: #888;">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶Ü‡ßü</small>
                        <div style="font-weight: bold;">‡ß≥ <span id="taskIncome">0.00</span></div>
                    </div>
                    <div style="flex: 1; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px;">
                        <small class="bn" style="color: #888;">‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶Ü‡ßü</small>
                        <div style="font-weight: bold;">‡ß≥ <span id="refIncome">0.00</span></div>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                <div class="glass" style="padding: 15px; text-align: center;" onclick="navTo('tasks')">
                    <i class="fas fa-play-circle" style="font-size: 1.8rem; color: #FF9F0A; margin-bottom: 8px;"></i>
                    <h4 class="bn">‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</h4>
                </div>
                <div class="glass" style="padding: 15px; text-align: center;" onclick="navTo('wallet')">
                    <i class="fas fa-hand-holding-usd" style="font-size: 1.8rem; color: #30D158; margin-bottom: 8px;"></i>
                    <h4 class="bn">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶§‡ßÅ‡¶≤‡ßÅ‡¶®</h4>
                </div>
            </div>

            <div class="glass" style="padding: 20px; border: 1px dashed var(--primary);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 50px; height: 50px; background: rgba(255,59,48,0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-users" style="color: var(--primary); font-size: 1.5rem;"></i>
                    </div>
                    <div style="flex: 1;">
                        <h4 class="bn">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶á‡¶®‡¶≠‡¶æ‡¶á‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h4>
                        <p class="bn" style="font-size: 0.8rem; color: #888;">‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá <span style="color: white; font-weight: bold;">‡ß≥ <span id="refBonusAmt">5.00</span></span> ‡¶¨‡ßã‡¶®‡¶æ‡¶∏</p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-main" style="padding: 10px; font-size: 0.9rem;" onclick="shareRef()"><i class="fas fa-share-alt"></i> ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</button>
                    <button class="btn-main" style="padding: 10px; font-size: 0.9rem; background: rgba(255,255,255,0.1); border: 1px solid #333;" onclick="copyRef()"><i class="fas fa-copy"></i> ‡¶ï‡¶™‡¶ø</button>
                </div>
                <input type="text" id="refLink" style="position: absolute; opacity: 0; pointer-events: none;">
            </div>
        </div>

        <div id="tasks" class="page">
            <h2 class="bn" style="margin-bottom: 5px;">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ú üìù</h2>
            <p class="bn" style="color: #888; margin-bottom: 25px;">‡¶ï‡¶æ‡¶ú‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶∞‡¶æ‡¶§ ‡ßß‡ß®‡¶ü‡¶æ‡ßü ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶π‡¶¨‡ßá‡•§</p>
            
            <div class="premium-ad-card">
                <i class="fas fa-play-circle ad-icon-small"></i>
                <h3 class="bn" style="font-size: 1.1rem; margin-bottom: 4px;">‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</h3>
                
                <div style="margin: 8px 0; display: flex; align-items: center; gap: 10px;">
                    <span class="bn" style="color: #ccc; font-size: 0.8rem;">‡¶¨‡¶æ‡¶ï‡¶ø: <span id="adsLeft" style="color: white; font-weight: bold;">0</span> ‡¶ü‡¶ø</span>
                    <span class="bn" style="background: rgba(48,209,88,0.15); color: var(--success); padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;">
                        +‡ß≥ <span id="adRateDisplay">0.00</span>
                    </span>
                </div>

                <button class="btn-main pulse-btn" style="padding: 10px 20px; font-size: 0.9rem; width: auto; margin-top: 5px;" onclick="watchAd()">
                    <i class="fas fa-video"></i> ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>

            <div id="taskList" style="margin-top: 25px;"></div>
        </div>

        <div id="leaderboard" class="page">
            <div style="text-align: center; margin-bottom: 25px;">
                <i class="fas fa-trophy" style="font-size: 3rem; color: #FFD700; margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.3));"></i>
                <h2 class="bn">‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶° üèÜ</h2>
                <p class="bn" style="color: #888;">‡¶∏‡ßá‡¶∞‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</p>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0 15px 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; color: #666; font-size: 0.8rem;">
                <span>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</span>
                <span>‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ / ‡¶≤‡¶æ‡¶á‡¶ï</span>
            </div>
            <div id="leaderboardList" class="rank-list">
                <div class="glass" style="padding:20px; text-align:center;">
                    <div class="loader-spin" style="margin: 0 auto;"></div>
                    <p class="bn" style="margin-top:10px;">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
                </div>
            </div>
        </div>

        <div id="wallet" class="page">
            <h2 class="bn" style="text-align: center; margin-bottom: 20px;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü üí≥</h2>
            <div class="tab-container">
                <div class="tab-btn active bn" onclick="switchWalletTab('withdraw', this)">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</div>
                <div class="tab-btn bn" onclick="switchWalletTab('history', this)">‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø</div>
            </div>
            
            <div id="withdrawTab">
                <div class="glass" style="padding: 20px; margin-bottom: 20px;">
                    <small class="bn" style="color: #888;">‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</small>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <span class="bn" style="background:#333; padding:5px 10px; border-radius:5px; font-size:0.8rem;">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï: <span id="wTaskBal">0</span>‡ß≥</span>
                        <span class="bn" style="background:#333; padding:5px 10px; border-radius:5px; font-size:0.8rem;">‡¶∞‡ßá‡¶´‡¶æ‡¶∞: <span id="wRefBal">0</span>‡ß≥</span>
                    </div>
                </div>

                <div class="glass" style="padding: 20px;">
                     <div style="margin-bottom: 15px;">
                        <label class="bn" style="display: block; margin-bottom: 8px; font-size: 0.9rem;">‡¶ï‡ßã‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶¨‡ßá‡¶®?</label>
                        <select id="wSource" class="form-control" onchange="updateWithdrawRulesUI()">
                            <option value="task">Main Balance (Task Income)</option>
                            <option value="ref">Referral Balance</option>
                        </select>
                    </div>

                    <!-- Dynamic Rules Box -->
                    <div class="warning-box">
                        <div class="warning-header">
                            <i class="fas fa-exclamation-triangle"></i> ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ (<span id="ruleType">Task</span>)
                        </div>
                        <ul class="bn" style="font-size: 0.85rem; color: #ccc; padding-left: 20px; margin: 0;">
                            <li style="margin-bottom: 5px;">‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞: <span style="color: white; font-weight:bold;">‡ß≥ <span id="ruleMinAmt">50</span></span></li>
                            <li>‡¶Æ‡¶ø‡¶®‡¶ø‡¶Æ‡¶æ‡¶Æ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá: <span style="color: white; font-weight:bold;"><span id="ruleMinRef">0</span> ‡¶ü‡¶ø</span> (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶õ‡ßá: <span id="userCurrentRef" style="color: #30D158;">0</span>)</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label class="bn" style="display: block; margin-bottom: 8px; font-size: 0.9rem;">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°</label>
                        <select id="wMethod" class="form-control">
                            <option value="bkash">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ (‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßã‡¶®‡¶æ‡¶≤)</option>
                            <option value="nagad">‡¶®‡¶ó‡¶¶ (‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßã‡¶®‡¶æ‡¶≤)</option>
                            <option value="rocket">‡¶∞‡¶ï‡ßá‡¶ü (‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßã‡¶®‡¶æ‡¶≤)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label class="bn" style="display: block; margin-bottom: 8px; font-size: 0.9rem;">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü (‡¶ü‡¶æ‡¶ï‡¶æ)</label>
                        <input type="number" id="wAmount" placeholder="‡ß´‡ß¶" class="form-control">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label class="bn" style="display: block; margin-bottom: 8px; font-size: 0.9rem;">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
                        <input type="number" id="wNumber" placeholder="017xxxxxxxx" class="form-control">
                    </div>

                    <!-- NEW: Verification Section (Hidden by Default) -->
                    <div id="verifySection" style="display: none; margin-bottom: 20px; text-align: center;">
                        <div class="warning-box" style="background: rgba(0, 122, 255, 0.1); border: 1px solid #007AFF;">
                            <div class="warning-header" style="color: #007AFF; justify-content: center;">
                                <i class="fas fa-shield-alt"></i> ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®
                            </div>
                            <p class="bn" style="font-size: 0.8rem; color: #ccc; margin-bottom: 10px;">
                                ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡•§
                                <br>
                                (<span id="verifyCountDisplay">0</span>/<span id="verifyTargetDisplay">1</span>) ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá
                            </p>
                            <button id="btnVerifyAction" class="btn-main" onclick="clickVerify()" style="background: linear-gradient(135deg, #007AFF 0%, #00C6FF 100%);">
                                <i class="fas fa-external-link-alt"></i> <span id="btnVerifyText">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                            </button>
                        </div>
                    </div>

                    <button id="btnWithdrawSubmit" class="btn-main" onclick="submitWithdraw()">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>
            
            <div id="historyTab" style="display: none;">
                <div class="glass" id="historyList" style="min-height: 200px;"></div>
            </div>
        </div>

        <div id="profile" class="page">
            <div style="text-align: center; margin-bottom: 30px; padding-top: 10px;">
                <img src="" id="profAvatar" style="width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--primary); padding: 3px;">
                <h2 id="profName" style="margin-top: 10px;">User Name</h2>
                <div class="bn" style="color: var(--text-muted); font-size: 0.9rem;">ID: <span id="profId">...</span></div>
                <div style="margin-top: 10px; font-size: 0.9rem;">
                    <i class="fas fa-heart" style="color: #FF2D55;"></i> ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶≤‡¶æ‡¶á‡¶ï: <span id="profLikes">0</span>
                </div>
            </div>
            
            <h3 class="bn" style="margin-bottom: 15px;">‡¶π‡ßá‡¶≤‡ßç‡¶™ ‡¶ì ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü üõ†Ô∏è</h3>
            
            <div id="supportBtnContainer" class="glass" style="padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                <!-- Links rendered via JS -->
            </div>

            <button class="btn-main" onclick="logoutApp()" style="background: #1C1C1E; border: 1px solid #333; color: #FF453A;">
                <i class="fas fa-sign-out-alt"></i> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
            </button>
        </div>
    </div>

    <nav class="nav-bar">
        <a href="#" class="nav-item active" onclick="navTo('home', this)">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item" onclick="navTo('tasks', this)">
            <i class="fas fa-check-square"></i>
            <span>Tasks</span>
        </a>
        <a href="#" class="nav-item" onclick="navTo('leaderboard', this)">
            <i class="fas fa-trophy"></i>
            <span>Top</span>
        </a>
        <a href="#" class="nav-item" onclick="navTo('wallet', this)">
            <i class="fas fa-wallet"></i>
            <span>Wallet</span>
        </a>
        <a href="#" class="nav-item" onclick="navTo('profile', this)">
            <i class="fas fa-user-circle"></i>
            <span>Profile</span>
        </a>
    </nav>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCNz6xpNVFYhrMWb90MGqPcc4_FXVGJRjI", 
            authDomain: "imo-clone-17935.firebaseapp.com",
            projectId: "imo-clone-17935",
            storageBucket: "imo-clone-17935.firebasestorage.app",
            messagingSenderId: "760912716104",
            appId: "1:760912716104:web:07aea8166ed4638f64537d"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const tg = window.Telegram.WebApp;
        tg.expand();

        let currentUser = null;
        let userData = {};
        
        // --- UPDATED CONFIG ---
        let appConfig = {
            notice: "‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶®‡•§",
            referralBonus: 5.00,
            adReward: 2.00,
            dailyAdLimit: 10,
            botUsername: "Apple_Earn_Incomebd_bot",
            adZoneId: "10312256", 
            withdrawRules: {
                task: { minAmount: 50, minRefs: 0 }, 
                ref: { minAmount: 100, minRefs: 5 }
            },
            // NEW VERIFICATION CONFIG (Admin can override this from DB)
            verification: {
                enabled: true,         // Toggle on/off
                link: "https://google.com", // The ad link
                requiredClicks: 2,     // How many clicks needed to unlock withdraw
                btnText: "Verify Reward üöÄ" 
            },
            tasks: [],
            supportLinks: [
                { title: '‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™', url: 'https://t.me/+W9u5nbxRn7lmMmY1', icon: 'fab fa-telegram-plane', color: '#0088cc' },
                { title: '‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤', url: 'https://t.me/APPLEEARN_OFFICIALCHANNEL', icon: 'fas fa-bullhorn', color: '#FF9F0A' },
                { title: '‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶≠‡ßá‡¶∏‡¶ø ‡¶™‡¶≤‡¶ø‡¶∏‡¶ø', url: 'https://t.me/Apple_income_help', icon: 'fas fa-shield-alt', color: '#30D158' },
                { title: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®', url: 'https://t.me/Apple_income_help', icon: 'fas fa-user-shield', color: '#FF3B30' }
            ]
        };

        // --- CACHE KEYS & TTL ---
        const CONFIG_CACHE_KEY = 'app_config_cache';
        const CONFIG_CACHE_TIME = 'app_config_time';
        const CONFIG_TTL = 60 * 60 * 1000; // 60 Minutes

        const LB_CACHE_KEY = 'lb_data_cache';
        const LB_CACHE_TIME = 'lb_time_cache';
        const LB_TTL = 15 * 60 * 1000; // 15 Minutes

        // New Variable for User Verification Tracking
        let userVerifyClicks = 0; 

        // --- Loader ---
        function runLoader() {
            let p = 0;
            const el = document.getElementById('loadPercent');
            const bar = document.getElementById('loadingBar');
            const interval = setInterval(() => {
                p += Math.floor(Math.random() * 5) + 1;
                if(p > 100) p = 100;
                el.innerText = p;
                bar.style.width = p + '%';
                if(p === 100) clearInterval(interval);
            }, 50);
        }

        // --- OPTIMIZED 1: Fetch Config with Caching ---
        async function fetchAppConfig() {
            try {
                const cached = localStorage.getItem(CONFIG_CACHE_KEY);
                const timestamp = localStorage.getItem(CONFIG_CACHE_TIME);
                const now = Date.now();

                if (cached && timestamp && (now - timestamp < CONFIG_TTL)) {
                    console.log("Using Cached Config");
                    const data = JSON.parse(cached);
                    appConfig = { ...appConfig, ...data };
                } else {
                    console.log("Fetching Config from Server...");
                    const configSnap = await db.collection('config').doc('appConfig').get();
                    if(configSnap.exists) {
                        const data = configSnap.data();
                        appConfig = { ...appConfig, ...data };
                        
                        // Default Fallback
                        if(!appConfig.withdrawRules) {
                            appConfig.withdrawRules = {
                                task: { minAmount: 50, minRefs: 0 },
                                ref: { minAmount: 100, minRefs: 2 }
                            };
                        }

                        // Save to Cache
                        localStorage.setItem(CONFIG_CACHE_KEY, JSON.stringify(appConfig));
                        localStorage.setItem(CONFIG_CACHE_TIME, now);
                    }
                }
            } catch (e) {
                console.error("Config fetch error, using defaults", e);
            }
        }

        // --- INIT ---
        async function initApp() {
            runLoader();

            try {
                // 1. Load Config (Cached)
                await fetchAppConfig();
                
                renderSupportLinks(); 
                document.getElementById('noticeText').innerHTML = appConfig.notice;
                document.getElementById('refBonusAmt').innerText = appConfig.referralBonus;
                document.getElementById('adRateDisplay').innerText = appConfig.adReward;

                // Load Ad SDK
                const script = document.createElement('script');
                script.src = '//libtl.com/sdk.js';
                script.dataset.zone = appConfig.adZoneId;
                script.dataset.sdk = 'show_' + appConfig.adZoneId;
                document.head.appendChild(script);

                // 2. Auth Logic
                let uid, name, photo;
                let startParam = null;

                if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const u = tg.initDataUnsafe.user;
                    uid = u.id.toString();
                    name = u.first_name + (u.last_name ? ' ' + u.last_name : '');
                    photo = u.photo_url;
                    startParam = tg.initDataUnsafe.start_param; 
                } else {
                    const cred = await auth.signInAnonymously();
                    uid = cred.user.uid;
                    name = "Guest User";
                }
                currentUser = uid;

                // 3. User Data
                const userRef = db.collection('users').doc(uid);
                const doc = await userRef.get();

                if(!doc.exists) {
                    // Create New User
                    const newUserObj = {
                        name: name,
                        uid: uid,
                        photo: photo || `https://ui-avatars.com/api/?name=${name}&background=FF3B30&color=fff`,
                        taskBalance: 0,
                        referralBalance: 0,
                        referralCount: 0,
                        likes: 0,
                        adsWatchedToday: 0,
                        adDate: new Date().toDateString(),
                        claimedTasksMap: {}, 
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        referredBy: startParam ? startParam.replace('ref_', '') : null
                    };

                    await userRef.set(newUserObj);
                    userData = newUserObj;

                    // Handle Referral Bonus
                    if (startParam && startParam.startsWith('ref_')) {
                        const referrerId = startParam.replace('ref_', '');
                        if (referrerId !== uid) {
                            try {
                                const refUserRef = db.collection('users').doc(referrerId);
                                await refUserRef.update({
                                    referralCount: firebase.firestore.FieldValue.increment(1),
                                    referralBalance: firebase.firestore.FieldValue.increment(appConfig.referralBonus)
                                });
                            } catch(err) { console.error("Referral Error:", err); }
                        }
                    }

                } else {
                    // Existing User
                    userData = doc.data();
                    
                    if(name !== userData.name) {
                        userRef.update({ name: name }); 
                        userData.name = name;
                    }

                    // Reset Daily Ads
                    const todayStr = new Date().toDateString();
                    if (userData.adDate !== todayStr) {
                         userRef.update({ adsWatchedToday: 0, adDate: todayStr });
                         userData.adsWatchedToday = 0;
                         userData.adDate = todayStr;
                    }
                }

                // 4. Initial UI Render
                updateUI();
                renderTasks();

                setTimeout(() => {
                    document.getElementById('appLoader').classList.remove('show');
                    document.getElementById('noticeModal').classList.add('show');
                }, 2000);

            } catch (e) {
                console.error(e);
                showToast("‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø! ‡¶™‡ßá‡¶ú‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "error");
            }
        }

        // --- UI FUNCS ---
        function formatMoney(amount) { return (amount || 0).toFixed(2); }

        function updateUI() {
            const total = (userData.taskBalance || 0) + (userData.referralBalance || 0);
            document.getElementById('userName').innerText = userData.name;
            document.getElementById('userAvatar').src = userData.photo;
            document.getElementById('profAvatar').src = userData.photo;
            document.getElementById('profName').innerText = userData.name;
            document.getElementById('profId').innerText = currentUser;
            document.getElementById('profLikes').innerText = userData.likes || 0; 

            document.getElementById('topBalance').innerText = formatMoney(total);
            document.getElementById('mainBalance').innerText = formatMoney(total);
            document.getElementById('taskIncome').innerText = formatMoney(userData.taskBalance);
            document.getElementById('refIncome').innerText = formatMoney(userData.referralBalance);
            
            const botLink = `https://t.me/${appConfig.botUsername}/app?startapp=ref_${currentUser}`;
            document.getElementById('refLink').value = botLink;
            
            const left = Math.max(0, appConfig.dailyAdLimit - (userData.adsWatchedToday || 0));
            document.getElementById('adsLeft').innerText = left;
            
            document.getElementById('wTaskBal').innerText = formatMoney(userData.taskBalance);
            document.getElementById('wRefBal').innerText = formatMoney(userData.referralBalance);

            updateWithdrawRulesUI();
        }

        // --- MODIFIED: Handle Verification UI Logic (Only for 20+ Referrals) ---
        function updateWithdrawRulesUI() {
            const source = document.getElementById('wSource').value;
            const rules = appConfig.withdrawRules[source] || { minAmount: 50, minRefs: 0 };
            
            // UI ‡¶§‡ßá ‡¶∞‡ßÅ‡¶≤‡¶∏ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
            document.getElementById('ruleType').innerText = source === 'task' ? 'Task' : 'Referral';
            document.getElementById('ruleMinAmt').innerText = rules.minAmount;
            document.getElementById('ruleMinRef').innerText = rules.minRefs;
            
            const userRefs = userData.referralCount || 0;
            const refCountEl = document.getElementById('userCurrentRef');
            refCountEl.innerText = userRefs;

            // ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶≤‡¶ú‡¶ø‡¶ï
            if(userRefs >= rules.minRefs) {
                refCountEl.style.color = '#30D158'; 
                refCountEl.innerHTML = `${userRefs} <i class="fas fa-check-circle"></i>`;
            } else {
                refCountEl.style.color = '#FF453A'; 
            }

            // --- VERIFICATION TOGGLE LOGIC ---
            const verifySection = document.getElementById('verifySection');
            const withdrawBtn = document.getElementById('btnWithdrawSubmit');
            const vConfig = appConfig.verification || {};
            
            // ‡¶∂‡¶∞‡ßç‡¶§: 
            // ‡ßß. ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á 'Referral' (ref) ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§
            // ‡ß®. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶Ö‡¶® ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§
            // ‡ß©. ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡ß®‡ß¶ ‡¶¨‡¶æ ‡¶§‡¶æ‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá (userRefs >= 20)‡•§
            
            if (source === 'ref' && vConfig.enabled === true && userRefs >= 20) {
                const required = vConfig.requiredClicks || 1;
                
                document.getElementById('verifyTargetDisplay').innerText = required;
                document.getElementById('btnVerifyText').innerText = vConfig.btnText || "Verify";

                if (userVerifyClicks >= required) {
                    // ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶≤‡ßá ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                    verifySection.style.display = 'none';
                    withdrawBtn.style.display = 'block';
                } else {
                    // ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                    verifySection.style.display = 'block';
                    withdrawBtn.style.display = 'none';
                    document.getElementById('verifyCountDisplay').innerText = userVerifyClicks;
                }
            } else {
                // ‡¶Ö‡¶®‡ßç‡¶Ø‡¶•‡¶æ‡ßü (‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ö‡¶•‡¶¨‡¶æ ‡ß®‡ß¶ ‡¶è‡¶∞ ‡¶ï‡¶Æ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶π‡¶≤‡ßá) ‡¶®‡¶∞‡¶Æ‡¶æ‡¶≤ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                verifySection.style.display = 'none';
                withdrawBtn.style.display = 'block';
            }
        }

        // --- NEW: Handle Verification Click ---
        function clickVerify() {
            const vConfig = appConfig.verification || {};
            const link = vConfig.link || "https://google.com"; 

            // Increment Click
            userVerifyClicks++;
            
            // UI Feedback
            const btn = document.getElementById('btnVerifyAction');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loader-spin"></div> Checking...';
            btn.disabled = true;

            // Open Link
            window.open(link, '_blank');
            showToast("‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "info");

            // Re-check after delay
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                
                if(userVerifyClicks >= (vConfig.requiredClicks || 1)) {
                    showToast("‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£ ‡¶∏‡¶´‡¶≤! ‡¶è‡¶ñ‡¶® ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§", "success");
                    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                } else {
                    const left = (vConfig.requiredClicks || 1) - userVerifyClicks;
                    showToast(`‡¶Ü‡¶∞‡¶ì ${left} ‡¶¨‡¶æ‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡•§`, "warning");
                }
                
                updateWithdrawRulesUI();
            }, 4000); // 4 seconds delay to simulate check
        }

        function renderSupportLinks() {
            const container = document.getElementById('supportBtnContainer');
            container.innerHTML = '';
            
            if(appConfig.supportLinks && appConfig.supportLinks.length > 0) {
                appConfig.supportLinks.forEach(link => {
                    const btn = document.createElement('div');
                    btn.style.cssText = `background: ${link.color}15; border: 1px solid ${link.color}40; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer;`;
                    btn.onclick = () => window.open(link.url, '_blank');
                    
                    btn.innerHTML = `
                        <i class="${link.icon}" style="font-size: 1.5rem; color: ${link.color}; margin-bottom: 8px;"></i>
                        <div class="bn" style="font-size: 0.85rem;">${link.title}</div>
                    `;
                    container.appendChild(btn);
                });
            } else {
                container.innerHTML = '<p class="bn" style="grid-column: span 2; text-align:center;">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶®‡ßá‡¶á</p>';
            }
        }

        function navTo(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }

            if(pageId === 'wallet') loadWithdrawHistory();
            if(pageId === 'leaderboard') loadLeaderboard(); // Now Cached
        }

        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred(type === 'error' ? 'error' : 'success');
            setTimeout(() => {
                toast.style.animation = 'slideDown 0.3s reverse forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- TASKS ---
        function renderTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = "";
            const claimedMap = userData.claimedTasksMap || {}; 
            const todayStr = new Date().toDateString();

            if(!appConfig.tasks || appConfig.tasks.length === 0) {
                list.innerHTML = `<p class="bn" style="text-align:center; color:#666;">‡¶Ü‡¶™‡¶æ‡¶§‡¶§ ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶®‡ßá‡¶á‡•§</p>`;
                return;
            }

            appConfig.tasks.forEach(task => {
                let isClaimedToday = (claimedMap[task.id] === todayStr);
                const isPending = localStorage.getItem(`task_pending_${task.id}`);
                let btnHtml = '';

                if(isClaimedToday) {
                    btnHtml = `<button class="btn-main" disabled style="padding: 6px 15px; width:auto; font-size: 0.8rem;"><i class="fas fa-check"></i> ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</button>`;
                } else if(isPending) {
                    btnHtml = `<button id="btn-${task.id}" class="btn-main btn-check" onclick="verifyTask('${task.id}', ${task.reward})" style="padding: 6px 15px; width:auto; font-size: 0.8rem;">Check <i class="fas fa-sync-alt"></i></button>`;
                } else {
                    btnHtml = `<button id="btn-${task.id}" class="btn-main" onclick="openTask('${task.id}', '${task.url}')" style="padding: 6px 15px; width:auto; font-size: 0.8rem;">Go <i class="fas fa-arrow-right"></i></button>`;
                }

                list.innerHTML += `
                <div class="task-box">
                    <div style="display: flex; align-items: center;">
                        <div class="task-icon"><i class="${task.icon}"></i></div>
                        <div class="task-info"><h4 class="bn">${task.title}</h4><div class="task-reward">+‡ß≥ ${task.reward}</div></div>
                    </div>
                    <div>${btnHtml}</div>
                </div>`;
            });
        }

        function openTask(taskId, url) {
            localStorage.setItem(`task_pending_${taskId}`, 'true');
            window.open(url, '_blank');
            setTimeout(() => { renderTasks(); showToast("‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶è‡¶∏‡ßá Check ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®", "info"); }, 1000);
        }

        async function verifyTask(taskId, reward) {
            const btn = document.getElementById(`btn-${taskId}`);
            btn.innerHTML = `<div class="loader-spin"></div>`; btn.disabled = true;
            
            setTimeout(async () => {
                try {
                    const todayStr = new Date().toDateString();
                    
                    // OPTIMIZATION: Optimistic UI Update (Update Local State first)
                    if (!userData.claimedTasksMap) userData.claimedTasksMap = {};
                    userData.claimedTasksMap[taskId] = todayStr;
                    userData.taskBalance += reward;
                    
                    // Fire update to DB (No read back)
                    const updateData = { taskBalance: firebase.firestore.FieldValue.increment(reward) };
                    updateData[`claimedTasksMap.${taskId}`] = todayStr;
                    await db.collection('users').doc(currentUser).update(updateData);
                    
                    localStorage.removeItem(`task_pending_${taskId}`);
                    
                    // Update UI manually
                    updateUI();
                    renderTasks();
                    
                    showToast(`‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶™‡¶®‡¶ø ‡ß≥${reward} ‡¶™‡ßá‡ßü‡ßá‡¶õ‡ßá‡¶®`, "success");
                } catch(e) { 
                    console.error(e); showToast("‡¶è‡¶∞‡¶∞ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "error"); 
                    btn.innerHTML = "Check"; btn.disabled = false; 
                }
            }, 3000); // 3 sec simulated delay
        }

        // --- SECURE AD SYSTEM (Time-Difference Based) ---
        async function watchAd() {
            if ((userData.adsWatchedToday || 0) >= appConfig.dailyAdLimit) {
                return showToast("‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶∂‡ßá‡¶∑!", "error");
            }
            
            const adFuncName = 'show_' + appConfig.adZoneId;
            if (typeof window[adFuncName] === 'function') {
                const startTime = Date.now(); // Record start time
                
                try {
                    // Call Ad SDK
                    await window[adFuncName]();
                    
                    // When user returns
                    const endTime = Date.now();
                    const duration = endTime - startTime; // Difference in milliseconds

                    // 10000 ms = 10 Seconds Threshold
                    if (duration < 10000) {
                        showToast("‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®‡¶ü‡¶ø ‡¶™‡ßÅ‡¶∞‡ßã ‡¶∏‡¶Æ‡ßü ‡¶¶‡ßá‡¶ñ‡ßá‡¶®‡¶®‡¶ø‡•§ ‡¶∞‡¶ø‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§", "error");
                    } else {
                        finishAd(); // Logic is secure now
                    }

                } catch (err) {
                    console.error("Ad Error:", err);
                    showToast("‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", "error");
                }
            } else {
                showToast("‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®", "error");
            }
        }
        
        async function finishAd() {
            try {
                // OPTIMIZATION: Optimistic UI Update
                const newDate = new Date().toDateString();
                userData.taskBalance += appConfig.adReward;
                userData.adsWatchedToday = (userData.adsWatchedToday || 0) + 1;
                userData.adDate = newDate;

                // Fire DB Update (Background)
                await db.collection('users').doc(currentUser).update({
                    taskBalance: firebase.firestore.FieldValue.increment(appConfig.adReward),
                    adsWatchedToday: firebase.firestore.FieldValue.increment(1),
                    adDate: newDate
                });
                
                updateUI(); // Reflect changes immediately
                showToast(`‡¶∏‡¶´‡¶≤! +‡ß≥${appConfig.adReward} ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, "success");
            } catch(e) { 
                showToast("‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï ‡¶è‡¶∞‡¶∞!", "error"); 
                // Revert optimistic update if error (optional but good practice)
                userData.taskBalance -= appConfig.adReward;
                userData.adsWatchedToday -= 1;
                updateUI();
            }
        }

        // --- WALLET ---
        function shareRef() {
            const url = document.getElementById('refLink').value;
            const text = encodeURIComponent("‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶≤ ‡¶Ü‡¶∞‡ßç‡¶®‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®! üëá");
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${text}`;
            window.open(shareUrl);
        }
        function copyRef() {
            const input = document.getElementById("refLink");
            const botLink = `https://t.me/${appConfig.botUsername}/app?startapp=ref_${currentUser}`;
            input.value = botLink;
            navigator.clipboard.writeText(input.value);
            showToast("‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        }
        function switchWalletTab(tab, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('withdrawTab').style.display = tab === 'withdraw' ? 'block' : 'none';
            document.getElementById('historyTab').style.display = tab === 'history' ? 'block' : 'none';
            if(tab === 'history') loadWithdrawHistory();
        }

        async function submitWithdraw() {
            const amount = parseFloat(document.getElementById('wAmount').value);
            const number = document.getElementById('wNumber').value;
            const method = document.getElementById('wMethod').value;
            const source = document.getElementById('wSource').value; 

            if (!amount || !number) return showToast("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®", "error");
            
            const rules = appConfig.withdrawRules[source];
            const minAmt = rules ? rules.minAmount : 50;
            const requiredRefs = rules ? rules.minRefs : 0;
            
            if (amount < minAmt) return showToast(`‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ${minAmt} ‡¶ü‡¶æ‡¶ï‡¶æ`, "error");

            const userRefs = userData.referralCount || 0;
            if (userRefs < requiredRefs) {
                const needed = requiredRefs - userRefs;
                return showToast(`‡¶è‡¶á ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶∞‡ßã ${needed} ‡¶ü‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®!`, "error");
            }
            
            const currentBal = source === 'task' ? (userData.taskBalance || 0) : (userData.referralBalance || 0);
            if (amount > currentBal) return showToast("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á!", "error");
            
            if (number.length < 11) return showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®", "error");

            if(!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?`)) return;

            try {
                // OPTIMIZATION: Optimistic Update
                if(source === 'task') userData.taskBalance -= amount;
                else userData.referralBalance -= amount;
                updateUI();

                const batch = db.batch();
                const userRef = db.collection('users').doc(currentUser);
                
                if(source === 'task') batch.update(userRef, { taskBalance: firebase.firestore.FieldValue.increment(-amount) });
                else batch.update(userRef, { referralBalance: firebase.firestore.FieldValue.increment(-amount) });

                batch.set(db.collection('withdrawals').doc(), {
                    uid: currentUser, amount, method, account: number, source: source, status: 'pending', 
                    date: firebase.firestore.FieldValue.serverTimestamp()
                });

                await batch.commit();
                showToast("‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
                document.getElementById('wAmount').value = "";
                switchWalletTab('history', document.querySelectorAll('.tab-btn')[1]);
            } catch(e) { console.error(e); showToast("‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶è‡¶∞‡¶∞‡•§", "error"); }
        }

        // --- OPTIMIZATION 2: Leaderboard Caching ---
        async function loadLeaderboard() {
            const list = document.getElementById('leaderboardList');
            const now = Date.now();
            
            const cachedData = localStorage.getItem(LB_CACHE_KEY);
            const cachedTime = localStorage.getItem(LB_CACHE_TIME);

            // Check Cache (15 Mins)
            if (cachedData && cachedTime && (now - cachedTime < LB_TTL)) {
                console.log("Loading Leaderboard from Cache");
                renderLeaderboard(JSON.parse(cachedData));
                return;
            }

            console.log("Fetching Leaderboard from Firestore");
            try {
                const snap = await db.collection('users').orderBy('taskBalance', 'desc').limit(50).get();
                if(snap.empty) { 
                    list.innerHTML = '<div class="glass" style="padding:20px;text-align:center;">‡¶ï‡¶æ‡¶â‡¶ï‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>'; 
                    return; 
                }
                
                let users = [];
                snap.forEach(doc => users.push(doc.data()));
                
                // Save to Cache
                localStorage.setItem(LB_CACHE_KEY, JSON.stringify(users));
                localStorage.setItem(LB_CACHE_TIME, now);

                renderLeaderboard(users);

            } catch(e) { console.error(e); list.innerHTML = '<div class="glass" style="padding:20px; text-align:center; color:#FF453A;">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø‡•§</div>'; }
        }

        function renderLeaderboard(users) {
            const list = document.getElementById('leaderboardList');
            let html = ''; let rank = 1;
            
            users.forEach(u => {
                let rankClass = rank === 1 ? 'top-1' : rank === 2 ? 'top-2' : rank === 3 ? 'top-3' : '';
                const isLiked = localStorage.getItem(`liked_${u.uid}`) ? 'liked' : '';
                
                html += `
                <div class="rank-item ${rankClass}">
                    <div style="display:flex; align-items:center; flex:1;">
                        <div class="rank-num">${rank}</div>
                        <img src="${u.photo || 'https://via.placeholder.com/40'}" class="rank-img">
                        <div class="rank-info"><div class="rank-name">${u.name.split(' ')[0]}</div><div class="rank-stats"><span>‡ß≥ ${formatMoney(u.taskBalance)}</span></div></div>
                    </div>
                    <div class="like-btn ${isLiked}" onclick="giveLike('${u.uid}', this)"><i class="${isLiked ? 'fas' : 'far'} fa-heart"></i><span class="like-count">${u.likes || 0}</span></div>
                </div>`;
                rank++;
            });
            list.innerHTML = html;
        }

        async function loadWithdrawHistory() {
            // Note: History is not heavily cached as users want to see real-time status updates
            const list = document.getElementById('historyList');
            try {
                const snap = await db.collection('withdrawals').where('uid', '==', currentUser).orderBy('date', 'desc').limit(20).get();
                if(snap.empty) return list.innerHTML = '<p class="bn" style="text-align:center; padding:30px; color:#666;">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á‡•§</p>';
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const color = d.status === 'paid' ? '#30D158' : '#FF9F0A';
                    html += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid rgba(255,255,255,0.05);">
                        <div><div class="bn" style="font-weight:600;">${d.method}</div><small class="bn" style="color:#666;">${d.date ? new Date(d.date.seconds * 1000).toLocaleDateString() : 'Processing...'}</small></div>
                        <div style="text-align:right;"><div style="font-weight:bold;">‡ß≥ ${d.amount}</div><span style="font-size:0.8rem; color:${color}; text-transform:uppercase;">${d.status}</span></div>
                    </div>`;
                });
                list.innerHTML = html;
            } catch(e) { console.error(e); list.innerHTML = '<p style="text-align:center;color:red">Error loading history.</p>'; }
        }

        async function giveLike(targetUid, btn) {
            if(targetUid === currentUser) return showToast("‡¶®‡¶ø‡¶ú‡ßá‡¶ï‡ßá ‡¶≤‡¶æ‡¶á‡¶ï ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ!", "error");
            if(localStorage.getItem(`liked_${targetUid}`)) return showToast("‡¶á‡¶§‡ßã‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶≤‡¶æ‡¶á‡¶ï ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®!", "info");
            
            // Optimistic UI
            btn.classList.add('liked'); 
            btn.querySelector('i').classList.replace('far', 'fas');
            let countSpan = btn.querySelector('.like-count'); 
            countSpan.innerText = parseInt(countSpan.innerText) + 1;
            
            localStorage.setItem(`liked_${targetUid}`, 'true');
            db.collection('users').doc(targetUid).update({ likes: firebase.firestore.FieldValue.increment(1) });
        }

        function logoutApp() { if(confirm("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) auth.signOut().then(()=>location.reload()); }
        window.onload = initApp;

    </script>
</body>
</html>
